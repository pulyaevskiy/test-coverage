# test_coverage 

[![pub package](https://img.shields.io/pub/v/test_coverage.svg?logo=dart&logoColor=00b9fc)](https://pub.dartlang.org/packages/test_coverage)
[![CI](https://img.shields.io/github/workflow/status/pulyaevskiy/test-coverage/Dart%20CI/master?logo=github-actions&logoColor=white)](https://github.com/pulyaevskiy/test-coverage/actions)
![Coverage](https://raw.githubusercontent.com/pulyaevskiy/test-coverage/master/coverage_badge.svg?sanitize=true)
[![Last Commits](https://img.shields.io/github/last-commit/pulyaevskiy/test-coverage?logo=git&logoColor=white)](https://github.com/pulyaevskiy/test-coverage/commits/master)
[![Pull Requests](https://img.shields.io/github/issues-pr/pulyaevskiy/test-coverage?logo=github&logoColor=white)](https://github.com/pulyaevskiy/test-coverage/pulls)
[![Code size](https://img.shields.io/github/languages/code-size/pulyaevskiy/test-coverage?logo=github&logoColor=white)](https://github.com/pulyaevskiy/test-coverage)
[![License](https://img.shields.io/github/license/pulyaevskiy/test-coverage?logo=open-source-initiative&logoColor=green)](https://github.com/pulyaevskiy/test-coverage/blob/master/LICENSE)

A simple command-line tool to collect test coverage information from
Dart VM tests. It is useful if you need to generate coverage reports
locally during development.

## Usage

Add dev dependency to your `pubspec.yaml`:

```yaml
dev_dependencies:
  test_coverage: ^0.6.0
```

Run `dart pub get` to install. Then, in the root of your project run:

```bash
dart pub run test_coverage
```

Result is saved in `coverage/lcov.info`. If you have `lcov` tool
installed on your system (for Mac it's `brew install lcov`) you can
generate coverage reports using `genhtml` command:

```bash
genhtml -o coverage coverage/lcov.info
# Open in the default browser (mac):
open coverage/index.html
```

#### Generating HTML report

You can also use the option `--gen-report`, usually accompanied by option `--open-report`:

```bash
dart pub run test_coverage --gen-report --open-report
```

#### Minimal coverage check
The option `--min-coverage` is used to check the minimal coverage percentage,
exiting `0` when OK, or `1` if coverage lower:

```bash
dart pub run test_coverage --min-coverage 70 --gen-report --open-report
```

#### Test output

Use the option `--print-test-output` to show test output in console.

## Integrations

Resulting `coverage/lcov.info` file is ready to be consumed by
Codecov command-line tool, so no extra step is needed.

This library was not tested with coveralls yet.

## Generating badge image

![Coverage](https://raw.githubusercontent.com/pulyaevskiy/test-coverage/master/coverage_badge.svg?sanitize=true)

Coverage badge SVG image is automatically generated and saved to `coverage_badge.svg` in your
project root directory. You can add it to Git and use in README.md on Github as follows:

```md
![Coverage](https://raw.githubusercontent.com/{you}/{repo}/master/coverage_badge.svg?sanitize=true)
```

If you don't need it you can pass `--no-badge` flag when running test coverage.


## Advanced options

### Example 1
 - Dart Observatory port 8789.
 - Minimal coverage of 40%.
 - No badge generation.
 - Print tests output.
 - Forces collect, avoiding Isolate pause.
 - Forces process to exit after collect coverage.
 - Generates report using `genhtml`.
 - Opens report in default browser.

```shell 
dart pub run test_coverage --port 8789 --min-coverage 40 --no-badge --print-test-output --force-collect --force-exit-after-collect --gen-report --open-report
```

### Example 2
- Print tests output.
- Forces collect, avoiding Isolate pause.
- Forces process to exit after collect coverage.
- Timeout of 60s to run all tests.

```shell 
dart pub run test_coverage --print-test-output --force-collect --force-exit-after-collect --timeout 60
```

## Help

See `--help` for all options and descriptions.

```shell
dart pub run test_coverage --help
```

## Known limitations

* This library was created to run Dart VM tests. It has not been tested
  and likely won't work for Dart code targeting web platform (compiled
  to JavaScript). There is no need to use this tool for Flutter as it
  allows collecting coverage information with `flutter test --coverage`.

## How it works

The tool performs following steps:

### 1. Generates `test/.test_coverage.dart` file (a "test all" script).

Scans your `test/` directory to find all `*_test.dart` files and creates `test/.test_coverage.dart`
which imports all found test files and runs corresponding `main()` of all tests functions within
the same file (and process), which simplifies collection of coverage information.

It is recommended to add this file to your `.gitignore`.

Below is an example of `test/.test_coverage.dart`:

```dart
// Auto-generated by test_coverage. Do not edit by hand.
// Consider adding this file to your .gitignore.

import 'some_test.dart' as some_test;
import 'nested/other_test.dart' as other_test;
import 'some_other_test.dart' as some_other_test;

void main() {
  some_test.main();
  other_test.main();
  some_other_test.main();
}
```

### 2. Runs the tests

Following command is used to run the tests:

```
dart --pause-isolates-on-exit --enable_asserts --enable-vm-service \
  test/.test_coverage.dart
```

### 3. Collects and formats coverage information

When test execution is completed the tool uses functionality of the
`coverage` package to collect and format coverage report.

Feel free to file feature requests and bug reports at the
[issue tracker][].

[issue tracker]: https://github.com/pulyaevskiy/test-coverage/issues

### 4. Minimal coverage percentage

Set minimal coverage percentage to pass
`--min-coverage` percentage value of coverage.

## Features and bugs

Please file feature requests and bugs at the [issue tracker][tracker].

[tracker]: https://github.com/pulyaevskiy/test-coverage/issues

## Author

- Anatoly Pulyaevskiy: [pulyaevskiy@GitHub](https://github.com/pulyaevskiy)

### Contributors
- Graciliano M. Passos: [gmpassos@GitHub](https://github.com/gmpassos).

## License

[BSD-3-Clause License](https://github.com/pulyaevskiy/test-coverage/blob/master/LICENSE).
